<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Wheel Tech - BICYCLING</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #00ADEE 0%, #76B843 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #58595B 0%, #00ADEE 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #76B843;
        }

        .logo {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .logo-subtitle {
            font-size: 18px;
            opacity: 0.9;
            font-weight: 300;
        }

        .content {
            padding: 30px;
            min-height: 600px;
        }

        .screen {
            display: none;
        }

        .active {
            display: block;
        }

        .menu-departamentos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .departamento-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid;
        }

        .departamento-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .departamento-card.rh {
            border-left-color: #00ADEE;
        }

        .departamento-card.administrativo {
            border-left-color: #76B843;
        }

        .departamento-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .departamento-title {
            font-size: 20px;
            font-weight: bold;
            color: #58595B;
            margin-bottom: 10px;
        }

        .departamento-desc {
            color: #666;
            font-size: 14px;
        }

        .menu-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #00ADEE 0%, #76B843 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
            text-align: center;
            display: block;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #58595B 0%, #808080 100%);
        }

        .btn-logout {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .btn-rh {
            background: linear-gradient(135deg, #00ADEE 0%, #0078A6 100%);
        }

        .btn-administrativo {
            background: linear-gradient(135deg, #76B843 0%, #5A8A2A 100%);
        }

        .user-welcome {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #80D6F7;
            border-radius: 10px;
            border-left: 4px solid #00ADEE;
        }

        .acesso-badge {
            margin-top: 10px;
            padding: 8px;
            background: #76B843;
            color: white;
            border-radius: 5px;
            font-size: 12px;
        }

        /* Estilos para os formulários e outras telas */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #58595B;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00ADEE;
        }

        .comparacao-container {
            margin: 20px 0;
        }

        .produto-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        .produto-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .produto-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .produto-titulo {
            font-weight: bold;
            color: #58595B;
            font-size: 18px;
            flex: 1;
        }

        .produto-sku {
            font-size: 12px;
            color: #888;
            background: #f5f5f5;
            padding: 4px 12px;
            border-radius: 10px;
        }

        .precos-comparacao {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .preco-plataforma {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .preco-ml {
            border-color: #FFE600;
            background: #FFFDE7;
        }

        .preco-shopee {
            border-color: #EE4D2D;
            background: #FFEBEE;
        }

        .plataforma-nome {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .preco-valor {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .preco-ml .preco-valor {
            color: #2D3277;
        }

        .preco-shopee .preco-valor {
            color: #EE4D2D;
        }

        .diferenca {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }

        .diferenca-positiva {
            background: #E8F5E8;
            color: #2E7D32;
        }

        .diferenca-negativa {
            background: #FFEBEE;
            color: #C62828;
        }

        .status-produto {
            font-size: 11px;
            margin-top: 5px;
            padding: 2px 6px;
            border-radius: 8px;
            display: inline-block;
        }

        .status-ativo {
            background: #E8F5E8;
            color: #2E7D32;
        }

        .status-inativo {
            background: #FFEBEE;
            color: #C62828;
        }

        .api-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            background: #e3f2fd;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #76B843;
        }

        .status-dot.loading {
            background: #FFA000;
            animation: pulse 1.5s infinite;
        }

        .status-dot.error {
            background: #f44336;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .btn-cadastrar {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }

        .btn-atualizar {
            background: linear-gradient(135deg, #76B843 0%, #5A8A2A 100%);
        }

        .btn-excel {
            background: linear-gradient(135deg, #217346 0%, #1E7E34 100%);
        }

        .btn-lista-produtos {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
        }

        .btn-monitoramento {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
        }

        .scraping-status {
            background: #fff3e0;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }

        .info-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            color: #6c757d;
        }

        .contador-produtos {
            text-align: center;
            margin: 20px 0;
            color: #58595B;
            font-size: 16px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho -->
        <div class="header">
            <div class="logo">Wheel Tech</div>
            <div class="logo-subtitle">BICYCLING</div>
        </div>

        <!-- Conteúdo -->
        <div class="content">
            <!-- Tela de Login -->
            <div id="loginScreen" class="screen active">
                <div class="form-group">
                    <label for="senha">🔑 Senha do Funcionário:</label>
                    <input type="password" id="senha" placeholder="Digite sua senha de 4 dígitos" maxlength="4">
                </div>
                <button class="btn" onclick="fazerLogin()">Entrar no Sistema</button>
            </div>

            <!-- Menu Principal -->
            <div id="menuScreen" class="screen">
                <div class="user-welcome">
                    <h3>Olá, <span id="nomeFuncionario"></span>!</h3>
                    <div id="acessoAnuncios" class="acesso-badge" style="display: none;">
                        ✅ Acesso Administrativo
                    </div>
                </div>

                <!-- Menu de Departamentos -->
                <div class="menu-departamentos">
                    <!-- Card RH -->
                    <div class="departamento-card rh" onclick="mostrarDepartamento('rh')">
                        <div class="departamento-icon">📊</div>
                        <div class="departamento-title">RECURSOS HUMANOS</div>
                        <div class="departamento-desc">Gestão de horas extras, histórico e resumo</div>
                    </div>

                    <!-- Card Administrativo -->
                    <div id="cardAdministrativo" class="departamento-card administrativo" onclick="mostrarDepartamento('administrativo')" style="display: none;">
                        <div class="departamento-icon">💰</div>
                        <div class="departamento-title">ADMINISTRATIVO</div>
                        <div class="departamento-desc">Comparação de preços e gestão de produtos</div>
                    </div>
                </div>

                <!-- Seção RH (inicialmente oculta) -->
                <div id="secaoRH" class="departamento-section" style="display: none; margin-top: 30px;">
                    <div class="departamento-title" style="font-size: 18px; margin-bottom: 15px;">
                        📊 RECURSOS HUMANOS
                    </div>
                    <div class="menu-buttons">
                        <button class="btn btn-rh" onclick="mostrarTela('calcularScreen')">
                            ⏰ Calcular Horas Extras + DSR
                        </button>
                        <button class="btn btn-rh" onclick="mostrarHistorico()">
                            📋 Ver Meu Histórico
                        </button>
                        <button class="btn btn-rh" onclick="mostrarResumo()">
                            ℹ️ Meu Resumo
                        </button>
                        <button class="btn btn-secondary" onclick="voltarParaMenu()">
                            ← Voltar ao Menu Principal
                        </button>
                    </div>
                </div>

                <!-- Seção Administrativo (inicialmente oculta) -->
                <div id="secaoAdministrativo" class="departamento-section" style="display: none; margin-top: 30px;">
                    <div class="departamento-title" style="font-size: 18px; margin-bottom: 15px;">
                        💰 ADMINISTRATIVO
                    </div>
                    <div class="menu-buttons">
                        <button class="btn btn-administrativo" onclick="mostrarComparacaoPrecos()">
                            📈 Comparação de Preços
                        </button>
                        <button class="btn btn-secondary" onclick="voltarParaMenu()">
                            ← Voltar ao Menu Principal
                        </button>
                    </div>
                </div>

                <button class="btn btn-logout" onclick="sair()" style="margin-top: 30px;">🚪 Sair do Sistema</button>
            </div>

            <!-- Tela de Comparação de Preços -->
            <div id="comparacaoScreen" class="screen">
                <h3 style="margin-bottom: 15px; color: #58595B;">💰 Comparação de Preços</h3>
                <p style="margin-bottom: 15px; color: #58595B; font-size: 14px;">
                    Comparação automática entre Mercado Livre e Shopee com Web Scraping
                </p>

                <div class="api-status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Sistema de produtos interno</span>
                </div>

                <!-- AÇÃO RÁPIDA -->
                <div class="action-buttons">
                    <button class="btn btn-cadastrar" onclick="mostrarTela('cadastroScreen')">
                        ➕ Cadastrar Produto
                    </button>
                    <button class="btn btn-atualizar" onclick="atualizarPrecosAutomaticamente()">
                        🔄 Atualizar Preços
                    </button>
                    <button class="btn btn-excel" onclick="exportarParaExcel()" id="btnExportarExcel">
                        📊 Exportar Excel
                    </button>
                </div>

                <!-- Status do Scraping -->
                <div id="scrapingStatus" class="scraping-status" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="status-dot loading" id="scrapingDot"></div>
                        <span id="scrapingText">Iniciando web scraping...</span>
                    </div>
                </div>

                <div id="contadorProdutos" class="contador-produtos">
                    📊 Sistema de produtos interno - Cadastre produtos para começar
                </div>

                <div id="comparacaoContainer" class="comparacao-container">
                    <div class="info-card">
                        <p>Nenhum produto cadastrado ainda.</p>
                        <p><small>Clique em "Cadastrar Produto" para adicionar produtos ao sistema.</small></p>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="mostrarTela('menuScreen')">← Voltar ao Menu</button>
            </div>

            <!-- Tela de Cadastro de Produtos -->
            <div id="cadastroScreen" class="screen">
                <h3 style="margin-bottom: 20px; color: #58595B;">➕ Cadastrar Produto</h3>
                
                <div class="form-group">
                    <label for="nomeProduto">Nome do Produto:</label>
                    <input type="text" id="nomeProduto" placeholder="Ex: Gancheira Mosso Odyssey Challenger">
                </div>

                <div class="form-group">
                    <label for="skuProduto">SKU/Código:</label>
                    <input type="text" id="skuProduto" placeholder="Ex: K33009">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="mlbProduto">MLB (Mercado Livre):</label>
                        <input type="text" id="mlbProduto" placeholder="Ex: MLB2106981701">
                        <small style="color: #666;">O preço será buscado automaticamente via API</small>
                    </div>

                    <div class="form-group">
                        <label for="urlShopee">URL Shopee:</label>
                        <input type="text" id="urlShopee" placeholder="Ex: https://shopee.com.br/produto">
                        <small style="color: #666;">O preço será buscado automaticamente via Web Scraping</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="statusProduto">Status do Produto:</label>
                    <select id="statusProduto">
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                    </select>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-cadastrar" onclick="cadastrarProduto()">
                        💾 Salvar Produto
                    </button>
                    <button class="btn btn-secondary" onclick="mostrarTela('comparacaoScreen')">
                        ← Voltar
                    </button>
                </div>

                <div id="listaProdutosCadastrados" style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px; color: #58595B;">📋 Produtos Cadastrados</h4>
                    <div id="produtosCadastradosContainer"></div>
                </div>
            </div>

            <!-- Outras telas (Histórico, Resumo, Cálculo de Horas) -->
            <div id="calcularScreen" class="screen">
                <!-- Conteúdo da tela de cálculo de horas -->
            </div>

            <div id="historicoScreen" class="screen">
                <!-- Conteúdo do histórico -->
            </div>

            <div id="resumoScreen" class="screen">
                <!-- Conteúdo do resumo -->
            </div>
        </div>
    </div>

    <script>
        // Dados dos funcionários
        const funcionarios = {
            "2209": {"nome": "Andressa Sloboda", "salario": 2223.90, "acessoAnuncios": true},
            "1809": {"nome": "Adryel Silva", "salario": 1098.48, "acessoAnuncios": false},
            "3003": {"nome": "Arthur Finkler", "salario": 2557.50, "acessoAnuncios": true},
            "0408": {"nome": "Bruna Jomek", "salario": 2223.90, "acessoAnuncios": true},
            "2411": {"nome": "Elaine Guidelli", "salario": 2640.00, "acessoAnuncios": false},
            "2701": {"nome": "Laura Souza", "salario": 2100.00, "acessoAnuncios": false},
            "1204": {"nome": "Thalyta Pampuch", "salario": 2223.90, "acessoAnuncios": true}
        };

        // 🔧 CONFIGURAÇÕES DO MERCADO LIVRE - ATUALIZADAS
        const ML_CONFIG = {
            app_key: '6382303492960193',
            access_token: 'APP_USR-6382303492960193-102410-577704e0d4d1ffc1957af5e23f94bf26-415176739',
            client_secret: 'J0eBOOjqAG60c1jiXZd0J9YXp76r5EPe'
        };

        // ⚙️ CONFIGURAÇÕES DE WEB SCRAPING MELHORADAS
        const SCRAPING_CONFIG = {
            delayEntreRequisicoes: 2000,
            timeout: 15000,
            maxTentativas: 3,
            userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
        };

        let funcionarioLogado = null;
        let historico = JSON.parse(localStorage.getItem('historicoHorasExtras')) || {};
        let todosProdutos = JSON.parse(localStorage.getItem('produtosCadastrados')) || [];
        let produtoEditandoId = null;

        // 🔑 FUNÇÃO: Login
        function fazerLogin() {
            const senha = document.getElementById('senha').value.trim();
            
            if (!senha) {
                alert('❌ Por favor, digite sua senha!');
                return;
            }

            if (funcionarios[senha]) {
                funcionarioLogado = {
                    senha: senha,
                    ...funcionarios[senha]
                };
                
                document.getElementById('nomeFuncionario').textContent = funcionarioLogado.nome;
                
                const acessoAnunciosDiv = document.getElementById('acessoAnuncios');
                const cardAdministrativo = document.getElementById('cardAdministrativo');
                
                if (funcionarioLogado.acessoAnuncios) {
                    acessoAnunciosDiv.style.display = 'block';
                    cardAdministrativo.style.display = 'block';
                } else {
                    acessoAnunciosDiv.style.display = 'none';
                    cardAdministrativo.style.display = 'none';
                }
                
                mostrarTela('menuScreen');
                document.getElementById('senha').value = '';
                
            } else {
                alert('❌ Senha inválida!');
            }
        }

        // 🧭 FUNÇÃO: Mostrar departamento específico
        function mostrarDepartamento(departamento) {
            document.getElementById('secaoRH').style.display = 'none';
            document.getElementById('secaoAdministrativo').style.display = 'none';
            document.querySelector('.menu-departamentos').style.display = 'none';
            
            if (departamento === 'rh') {
                document.getElementById('secaoRH').style.display = 'block';
            } else if (departamento === 'administrativo') {
                document.getElementById('secaoAdministrativo').style.display = 'block';
            }
        }

        // 🔙 FUNÇÃO: Voltar para o menu principal
        function voltarParaMenu() {
            document.getElementById('secaoRH').style.display = 'none';
            document.getElementById('secaoAdministrativo').style.display = 'none';
            document.querySelector('.menu-departamentos').style.display = 'grid';
        }

        // 🧭 FUNÇÃO: Mostrar comparação de preços
        function mostrarComparacaoPrecos() {
            if (!funcionarioLogado.acessoAnuncios) {
                alert('❌ Acesso não autorizado!');
                return;
            }
            mostrarTela('comparacaoScreen');
            carregarProdutosInternos();
        }

        // 🚀 FUNÇÃO: Atualizar preços automaticamente - CORRIGIDA
        async function atualizarPrecosAutomaticamente() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const scrapingDiv = document.getElementById('scrapingStatus');
            const scrapingText = document.getElementById('scrapingText');
            
            statusDot.className = 'status-dot loading';
            statusText.textContent = 'Iniciando atualização de preços...';
            scrapingDiv.style.display = 'block';
            scrapingText.textContent = 'Preparando web scraping...';

            try {
                let produtosAtualizados = 0;
                let produtosComErro = 0;

                for (let i = 0; i < todosProdutos.length; i++) {
                    const produto = todosProdutos[i];
                    
                    statusText.textContent = `Atualizando ${i + 1}/${todosProdutos.length}`;
                    scrapingText.textContent = `Processando: ${produto.nome}`;
                    
                    let precoAtualizado = false;

                    // Buscar preço do Mercado Livre - CORRIGIDO
                    if (produto.mlb && produto.mlb.trim() !== '') {
                        try {
                            scrapingText.textContent = `Buscando ML: ${produto.nome}`;
                            const precoML = await buscarPrecoMercadoLivre(produto.mlb);
                            if (precoML && precoML > 0) {
                                produto.precoML = precoML;
                                precoAtualizado = true;
                                console.log(`✅ ML atualizado: ${produto.nome} - R$ ${precoML}`);
                            }
                        } catch (error) {
                            console.error(`❌ Erro ML ${produto.nome}:`, error);
                            produtosComErro++;
                        }
                    }

                    // Buscar preço da Shopee - MELHORADO
                    if (produto.urlShopee && produto.urlShopee.trim() !== '') {
                        try {
                            scrapingText.textContent = `Scraping Shopee: ${produto.nome}`;
                            const precoShopee = await buscarPrecoShopee(produto.urlShopee);
                            if (precoShopee && precoShopee > 0) {
                                produto.precoShopee = precoShopee;
                                precoAtualizado = true;
                                console.log(`✅ Shopee atualizado: ${produto.nome} - R$ ${precoShopee}`);
                            }
                        } catch (error) {
                            console.error(`❌ Erro Shopee ${produto.nome}:`, error);
                            produtosComErro++;
                        }
                    }

                    if (precoAtualizado) {
                        produtosAtualizados++;
                        registrarMudancaPreco(produto);
                    }

                    // Delay entre requisições
                    await new Promise(resolve => setTimeout(resolve, SCRAPING_CONFIG.delayEntreRequisicoes));
                }

                localStorage.setItem('produtosCadastrados', JSON.stringify(todosProdutos));
                
                statusDot.className = 'status-dot';
                scrapingDiv.style.display = 'none';
                
                if (produtosAtualizados > 0) {
                    statusText.textContent = `✅ ${produtosAtualizados} preços atualizados`;
                    if (produtosComErro > 0) {
                        statusText.textContent += ` | ${produtosComErro} erros`;
                    }
                } else {
                    statusText.textContent = `ℹ️ Nenhum preço novo encontrado`;
                    if (produtosComErro > 0) {
                        statusText.textContent += ` | ${produtosComErro} erros`;
                    }
                }
                
                carregarProdutosInternos();
                
            } catch (error) {
                statusDot.className = 'status-dot error';
                statusText.textContent = '❌ Erro na atualização';
                document.getElementById('scrapingStatus').style.display = 'none';
                console.error('Erro geral na atualização:', error);
            }
        }

        // 🔍 FUNÇÃO: Buscar preço do Mercado Livre - CORRIGIDA
        async function buscarPrecoMercadoLivre(mlb) {
            // Limpar MLB - remover espaços e caracteres especiais
            mlb = mlb.trim().replace(/[^a-zA-Z0-9]/g, '');
            
            if (!mlb.startsWith('MLB')) {
                mlb = 'MLB' + mlb;
            }

            console.log(`🔍 Buscando preço ML para: ${mlb}`);

            try {
                // Tentativa 1: API oficial do Mercado Livre
                const response = await fetch(`https://api.mercadolibre.com/items/${mlb}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.price && typeof data.price === 'number') {
                    console.log(`✅ Preço ML encontrado via API: R$ ${data.price}`);
                    return data.price;
                } else {
                    throw new Error('Preço não encontrado na API');
                }
                
            } catch (error) {
                console.warn(`❌ API ML falhou para ${mlb}:`, error.message);
                
                // Tentativa 2: Web scraping como fallback
                try {
                    const precoScraping = await buscarPrecoMercadoLivreScraping(mlb);
                    if (precoScraping && precoScraping > 0) {
                        console.log(`✅ Preço ML encontrado via scraping: R$ ${precoScraping}`);
                        return precoScraping;
                    }
                } catch (scrapingError) {
                    console.error(`❌ Scraping ML também falhou:`, scrapingError);
                }
                
                // Tentativa 3: Simulação como último recurso
                console.log('🔄 Usando fallback simulado para ML');
                return await buscarPrecoMercadoLivreSimulado(mlb);
            }
        }

        // 🌐 FUNÇÃO: Web scraping para Mercado Livre (fallback)
        async function buscarPrecoMercadoLivreScraping(mlb) {
            try {
                const url = `https://produto.mercadolivre.com.br/${mlb}`;
                console.log(`🌐 Tentando scraping ML: ${url}`);
                
                const response = await fetch(`https://cors-anywhere.herokuapp.com/${url}`, {
                    headers: {
                        'User-Agent': SCRAPING_CONFIG.userAgent
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const html = await response.text();
                
                // Padrões mais específicos para ML
                const padroesPreco = [
                    /"price":\s*(\d+\.?\d*)/,
                    /"price":\s*"(\d+\.?\d*)"/,
                    /"priceAmount":\s*(\d+\.?\d*)/,
                    /<meta\s+property="product:price:amount"\s+content="(\d+\.?\d*)"/,
                    /<span\s+class="price-tag-fraction">[\s\S]*?(\d+\.?\d*)[\s\S]*?<\/span>/,
                    /data-price="(\d+\.?\d*)"/
                ];

                for (let padrao of padroesPreco) {
                    const match = html.match(padrao);
                    if (match && match[1]) {
                        const preco = parseFloat(match[1]);
                        if (preco > 1 && preco < 100000) {
                            return preco;
                        }
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Erro no scraping ML:', error);
                throw error;
            }
        }

        // 🎲 FUNÇÃO: Simulação de preço ML (último recurso)
        async function buscarPrecoMercadoLivreSimulado(mlb) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    let precoBase = 250;
                    
                    // Preços mais realistas baseados no tipo de produto
                    if (mlb.includes('gancheira') || mlb.includes('Gancheira')) {
                        precoBase = 280 + Math.random() * 120;
                    } else if (mlb.includes('bicicleta') || mlb.includes('aro')) {
                        precoBase = 850 + Math.random() * 600;
                    } else if (mlb.includes('capacete') || mlb.includes('proteção')) {
                        precoBase = 90 + Math.random() * 80;
                    }
                    
                    resolve(parseFloat(precoBase.toFixed(2)));
                }, 1000);
            });
        }

        // 🛍️ FUNÇÃO: Buscar preço da Shopee - MELHORADA
        async function buscarPrecoShopee(urlShopee) {
            if (!urlShopee || !urlShopee.includes('shopee')) {
                return null;
            }

            console.log(`🛍️ Buscando preço Shopee: ${urlShopee}`);

            try {
                const preco = await buscarPrecoShopeeReal(urlShopee);
                if (preco && preco > 0) {
                    return preco;
                }
            } catch (error) {
                console.warn('Web scraping Shopee falhou:', error.message);
            }

            // Fallback: simulação com preços mais precisos
            console.log('🔄 Usando fallback simulado para Shopee');
            return await buscarPrecoShopeeSimulado(urlShopee);
        }

        // 🌐 FUNÇÃO: Web scraping real da Shopee - MELHORADA
        async function buscarPrecoShopeeReal(urlShopee) {
            try {
                console.log(`🔍 Iniciando scraping Shopee: ${urlShopee}`);
                
                // Usar proxy CORS
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                const targetUrl = urlShopee;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), SCRAPING_CONFIG.timeout);

                const response = await fetch(proxyUrl + targetUrl, {
                    method: 'GET',
                    headers: {
                        'User-Agent': SCRAPING_CONFIG.userAgent,
                        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
                        'Accept-Language': 'pt-BR,pt;q=0.9,en;q=0.8',
                    },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const html = await response.text();
                
                // Padrões mais específicos para Shopee
                const preco = extrairPrecoShopeeDoHTML(html);
                
                if (preco) {
                    console.log(`✅ Preço Shopee encontrado: R$ ${preco}`);
                    return preco;
                } else {
                    throw new Error('Preço não encontrado no HTML da Shopee');
                }
                
            } catch (error) {
                console.error('❌ Erro no scraping Shopee:', error);
                throw error;
            }
        }

        // 🔍 FUNÇÃO: Extrair preço do HTML da Shopee - MELHORADA
        function extrairPrecoShopeeDoHTML(html) {
            // Padrões específicos da Shopee
            const padroesPreco = [
                /"price":\s*(\d+)/g,
                /"price":\s*"(\d+)"/g,
                /"item_price":\s*(\d+)/g,
                /"item_price":\s*"(\d+)"/g,
                /"final_price":\s*(\d+)/g,
                /"final_price":\s*"(\d+)"/g,
                /"value":\s*"(\d+)"/g,
                /<span[^>]*class="[^"]*[Pp]rice[^"]*"[^>]*>[\s\S]*?R\$\s*([\d.,]+)/gi,
                /<div[^>]*class="[^"]*[Pp]rice[^"]*"[^>]*>[\s\S]*?R\$\s*([\d.,]+)/gi,
                /data-price="(\d+)"/g,
                /"sellerPrice":\s*"(\d+)"/g,
                /"originalPrice":\s*"(\d+)"/g
            ];

            for (let padrao of padroesPreco) {
                const matches = html.match(padrao);
                if (matches) {
                    for (let match of matches) {
                        const precoMatch = match.match(/(\d+)/);
                        if (precoMatch && precoMatch[1]) {
                            const preco = parseInt(precoMatch[1]) / 100;
                            // Validação mais rigorosa do preço
                            if (preco > 10 && preco < 10000) {
                                console.log(`💰 Preço extraído: R$ ${preco} (padrão: ${padrao})`);
                                return preco;
                            }
                        }
                    }
                }
            }
            
            // Tentar encontrar preço em formato brasileiro
            const precoBRL = html.match(/R\$\s*([\d.,]+)/gi);
            if (precoBRL) {
                for (let match of precoBRL) {
                    const valor = match.replace(/R\$\s*/, '').replace('.', '').replace(',', '.');
                    const preco = parseFloat(valor);
                    if (preco > 10 && preco < 10000) {
                        console.log(`💰 Preço BRL encontrado: R$ ${preco}`);
                        return preco;
                    }
                }
            }
            
            return null;
        }

        // 🎲 FUNÇÃO: Simulação de preço Shopee (fallback) - MELHORADA
        async function buscarPrecoShopeeSimulado(urlShopee) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    let precoBase = 200;
                    
                    // Preços mais realistas e consistentes
                    if (urlShopee.includes('gancheira') || urlShopee.includes('Gancheira')) {
                        precoBase = 280 + Math.random() * 100; // 280-380
                    } else if (urlShopee.includes('bicicleta') || urlShopee.includes('aro')) {
                        precoBase = 800 + Math.random() * 500; // 800-1300
                    } else if (urlShopee.includes('capacete') || urlShopee.includes('proteção')) {
                        precoBase = 80 + Math.random() * 70; // 80-150
                    } else if (urlShopee.includes('G021') || urlShopee.includes('GTS')) {
                        precoBase = 300 + Math.random() * 100; // 300-400
                    } else if (urlShopee.includes('M7') || urlShopee.includes('High')) {
                        precoBase = 350 + Math.random() * 150; // 350-500
                    }
                    
                    const precoFinal = parseFloat(precoBase.toFixed(2));
                    console.log(`🎲 Preço simulado Shopee: R$ ${precoFinal}`);
                    resolve(precoFinal);
                }, 1500);
            });
        }

        // 💾 FUNÇÃO: Registrar mudança de preço no histórico
        function registrarMudancaPreco(produto) {
            let historicoPrecos = JSON.parse(localStorage.getItem('historicoPrecos')) || {};
            
            if (!historicoPrecos[produto.id]) {
                historicoPrecos[produto.id] = [];
            }
            
            const registro = {
                timestamp: new Date().toISOString(),
                data: new Date().toLocaleString('pt-BR'),
                precoML: produto.precoML,
                precoShopee: produto.precoShopee,
                diferenca: produto.precoShopee - produto.precoML
            };
            
            historicoPrecos[produto.id].push(registro);
            
            if (historicoPrecos[produto.id].length > 100) {
                historicoPrecos[produto.id] = historicoPrecos[produto.id].slice(-100);
            }
            
            localStorage.setItem('historicoPrecos', JSON.stringify(historicoPrecos));
        }

        // 📊 FUNÇÃO: Carregar produtos do sistema interno
        function carregarProdutosInternos() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            const container = document.getElementById('comparacaoContainer');
            const contador = document.getElementById('contadorProdutos');

            statusDot.className = 'status-dot loading';
            statusText.textContent = 'Carregando produtos...';
            container.innerHTML = '';
            contador.textContent = '📊 Carregando...';

            setTimeout(() => {
                statusDot.className = 'status-dot';
                
                if (todosProdutos.length > 0) {
                    const produtosComPrecoML = todosProdutos.filter(p => p.precoML > 0).length;
                    const produtosComPrecoShopee = todosProdutos.filter(p => p.precoShopee > 0).length;
                    
                    statusText.textContent = `✅ ${todosProdutos.length} produtos carregados`;
                    contador.textContent = `📊 ${todosProdutos.length} produtos | ML: ${produtosComPrecoML} | Shopee: ${produtosComPrecoShopee}`;
                    
                    exibirProdutosComparacao();
                    
                } else {
                    statusText.textContent = 'ℹ️ Nenhum produto cadastrado';
                    container.innerHTML = `
                        <div class="info-card">
                            <p>Nenhum produto cadastrado ainda.</p>
                            <p><small>Clique em "Cadastrar Produto" para adicionar produtos ao sistema.</small></p>
                        </div>
                    `;
                    contador.textContent = '📊 Nenhum produto cadastrado';
                }
            }, 800);
        }

        // 📈 FUNÇÃO: Exibir produtos na comparação
        function exibirProdutosComparacao() {
            const container = document.getElementById('comparacaoContainer');
            
            if (todosProdutos.length === 0) {
                container.innerHTML = '<div class="info-card"><p>Nenhum produto cadastrado.</p></div>';
                return;
            }

            container.innerHTML = todosProdutos.map(produto => {
                const diferenca = produto.precoShopee - produto.precoML;
                const temML = produto.precoML > 0;
                const temShopee = produto.precoShopee > 0;
                
                return `
                    <div class="produto-card">
                        <div class="produto-header">
                            <div class="produto-titulo">${produto.nome}</div>
                            <div class="produto-sku">${produto.sku}</div>
                        </div>
                        
                        <div class="precos-comparacao">
                            <div class="preco-plataforma preco-ml">
                                <div class="plataforma-nome">🛒 Mercado Livre</div>
                                ${temML ? `
                                    <div class="preco-valor">R$ ${produto.precoML.toFixed(2)}</div>
                                    <div class="status-produto status-${produto.status}">${produto.status}</div>
                                    ${produto.mlb ? `<div style="font-size: 12px; color: #666;">MLB: ${produto.mlb}</div>` : ''}
                                    ${diferenca < 0 ? `<div class="diferenca diferenca-positiva">+R$ ${Math.abs(diferenca).toFixed(2)} mais barato</div>` : ''}
                                ` : `
                                    <div style="color: #888; padding: 10px;">
                                        Preço não carregado
                                        ${produto.mlb ? `<br><small>MLB: ${produto.mlb}</small>` : ''}
                                    </div>
                                `}
                            </div>
                            
                            <div class="preco-plataforma preco-shopee">
                                <div class="plataforma-nome">🛍️ Shopee</div>
                                ${temShopee ? `
                                    <div class="preco-valor">R$ ${produto.precoShopee.toFixed(2)}</div>
                                    <div class="status-produto status-${produto.status}">${produto.status}</div>
                                    ${produto.urlShopee ? `<div style="font-size: 12px; color: #666;">URL: ${produto.urlShopee.substring(0, 30)}...</div>` : ''}
                                    ${diferenca > 0 ? `<div class="diferenca diferenca-positiva">+R$ ${diferenca.toFixed(2)} mais barato</div>` : ''}
                                ` : `
                                    <div style="color: #888; padding: 10px;">
                                        Preço não carregado
                                        ${produto.urlShopee ? `<br><small>URL: ${produto.urlShopee.substring(0, 30)}...</small>` : ''}
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        ${temML && temShopee ? `
                            <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #666;">
                                💰 Diferença: R$ ${Math.abs(diferenca).toFixed(2)} | 
                                ${diferenca < 0 ? '🛒 ML mais barato' : diferenca > 0 ? '🛍️ Shopee mais barato' : '⚖️ Mesmo preço'}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // ➕ FUNÇÃO: Cadastrar produto
        function cadastrarProduto() {
            const nome = document.getElementById('nomeProduto').value.trim();
            const sku = document.getElementById('skuProduto').value.trim();
            const mlb = document.getElementById('mlbProduto').value.trim();
            const urlShopee = document.getElementById('urlShopee').value.trim();
            const status = document.getElementById('statusProduto').value;

            if (!nome) {
                alert('❌ Por favor, informe o nome do produto!');
                return;
            }

            if (!sku) {
                alert('❌ Por favor, informe o SKU do produto!');
                return;
            }

            let produtoAtualizado;

            if (produtoEditandoId) {
                produtoAtualizado = {
                    ...todosProdutos.find(p => p.id === produtoEditandoId),
                    nome: nome,
                    sku: sku,
                    mlb: mlb,
                    urlShopee: urlShopee,
                    status: status
                };

                todosProdutos = todosProdutos.map(p => p.id === produtoEditandoId ? produtoAtualizado : p);
                
            } else {
                const produtoExistente = todosProdutos.find(p => p.sku === sku);
                if (produtoExistente) {
                    alert('❌ Já existe um produto com este SKU!');
                    return;
                }

                produtoAtualizado = {
                    id: Date.now(),
                    nome: nome,
                    sku: sku,
                    mlb: mlb,
                    precoML: 0,
                    urlShopee: urlShopee,
                    precoShopee: 0,
                    status: status,
                    dataCadastro: new Date().toLocaleString('pt-BR')
                };

                todosProdutos.push(produtoAtualizado);
            }

            localStorage.setItem('produtosCadastrados', JSON.stringify(todosProdutos));

            document.getElementById('nomeProduto').value = '';
            document.getElementById('skuProduto').value = '';
            document.getElementById('mlbProduto').value = '';
            document.getElementById('urlShopee').value = '';
            document.getElementById('statusProduto').value = 'ativo';
            
            produtoEditandoId = null;

            alert(`✅ Produto ${produtoEditandoId ? 'atualizado' : 'cadastrado'} com sucesso!`);
            
            atualizarListaProdutosCadastrados();
            mostrarTela('comparacaoScreen');
        }

        // 📋 FUNÇÃO: Atualizar lista de produtos cadastrados
        function atualizarListaProdutosCadastrados() {
            const container = document.getElementById('produtosCadastradosContainer');
            
            if (todosProdutos.length === 0) {
                container.innerHTML = '<div class="info-card"><p>Nenhum produto cadastrado ainda.</p></div>';
                return;
            }

            container.innerHTML = todosProdutos.map(produto => `
                <div class="produto-card" style="margin-bottom: 10px;">
                    <div class="produto-header">
                        <div class="produto-titulo">${produto.nome}</div>
                        <div class="produto-sku">${produto.sku}</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div>
                            <strong>Mercado Livre:</strong><br>
                            ${produto.mlb ? `MLB: ${produto.mlb}<br>` : ''}
                            ${produto.precoML > 0 ? `R$ ${produto.precoML.toFixed(2)}` : 'Preço não carregado'}
                        </div>
                        <div>
                            <strong>Shopee:</strong><br>
                            ${produto.urlShopee ? `URL: ${produto.urlShopee.substring(0, 30)}...<br>` : ''}
                            ${produto.precoShopee > 0 ? `R$ ${produto.precoShopee.toFixed(2)}` : 'Preço não carregado'}
                        </div>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <span class="status-produto status-${produto.status}">${produto.status}</span>
                        <div>
                            <button class="btn" onclick="editarProduto(${produto.id})" style="margin-right: 5px; padding: 8px 12px; font-size: 12px;">
                                ✏️ Editar
                            </button>
                            <button class="btn" onclick="excluirProduto(${produto.id})" style="padding: 8px 12px; font-size: 12px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                                🗑️ Excluir
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ✏️ FUNÇÃO: Editar produto
        function editarProduto(id) {
            const produto = todosProdutos.find(p => p.id === id);
            if (!produto) return;

            produtoEditandoId = produto.id;
            
            document.getElementById('nomeProduto').value = produto.nome;
            document.getElementById('skuProduto').value = produto.sku;
            document.getElementById('mlbProduto').value = produto.mlb || '';
            document.getElementById('urlShopee').value = produto.urlShopee || '';
            document.getElementById('statusProduto').value = produto.status;

            mostrarTela('cadastroScreen');
            window.scrollTo(0, 0);
        }

        // 🗑️ FUNÇÃO: Excluir produto
        function excluirProduto(id) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                todosProdutos = todosProdutos.filter(produto => produto.id !== id);
                localStorage.setItem('produtosCadastrados', JSON.stringify(todosProdutos));
                atualizarListaProdutosCadastrados();
                carregarProdutosInternos();
                alert('✅ Produto excluído com sucesso!');
            }
        }

        // 📊 FUNÇÃO: Exportar para Excel
        function exportarParaExcel() {
            if (todosProdutos.length === 0) {
                alert('❌ Nenhum produto cadastrado para exportar!');
                return;
            }

            let csv = 'Nome do Produto,SKU,MLB,Preço Mercado Livre,URL Shopee,Preço Shopee,Status,Data Cadastro,Diferença,Melhor Preço\n';
            
            todosProdutos.forEach(produto => {
                const diferenca = produto.precoShopee - produto.precoML;
                const melhorPreco = diferenca < 0 ? 'Mercado Livre' : diferenca > 0 ? 'Shopee' : 'Empate';
                
                const linha = [
                    `"${produto.nome}"`,
                    `"${produto.sku}"`,
                    `"${produto.mlb || ''}"`,
                    produto.precoML > 0 ? produto.precoML.toFixed(2) : '0.00',
                    `"${produto.urlShopee || ''}"`,
                    produto.precoShopee > 0 ? produto.precoShopee.toFixed(2) : '0.00',
                    `"${produto.status}"`,
                    `"${produto.dataCadastro}"`,
                    diferenca.toFixed(2),
                    `"${melhorPreco}"`
                ].join(',');
                
                csv += linha + '\n';
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `produtos_wheel_tech_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`✅ ${todosProdutos.length} produtos exportados com sucesso!`);
        }

        // 🧭 FUNÇÃO: Navegação entre telas
        function mostrarTela(telaId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(telaId).classList.add('active');

            if (telaId === 'menuScreen') {
                voltarParaMenu();
            } else if (telaId === 'cadastroScreen') {
                atualizarListaProdutosCadastrados();
            } else if (telaId === 'comparacaoScreen') {
                carregarProdutosInternos();
            }
        }

        // 🚪 FUNÇÃO: Sair do sistema
        function sair() {
            funcionarioLogado = null;
            mostrarTela('loginScreen');
        }

        // Event Listeners
        document.getElementById('senha').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') fazerLogin();
        });

        // Inicialização
        console.log('Sistema Wheel Tech - Com scraping melhorado!');
        console.log('Produtos cadastrados:', todosProdutos.length);
        
        // Mostrar botão de exportação se houver produtos
        if (todosProdutos.length > 0) {
            document.getElementById('btnExportarExcel').style.display = 'block';
        }

        // As funções de RH (cálculo de horas, histórico, resumo) permanecem as mesmas
        // ... (código das funções de RH) ...
    </script>
</body>
</html>