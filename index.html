<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ordem de Servi√ßo - Fotografia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #8A2BE2;
            --secondary: #FF6B8B;
            --success: #00D26A;
            --warning: #FFA500;
            --danger: #FF4757;
            --info: #00CED1;
            --light: #F8F9FA;
            --dark: #2C3E50;
            --purple: #9B59B6;
            --teal: #20B2AA;
            --orange: #FF7F50;
            --pink: #FF69B4;
            --blue: #4169E1;
            --neutral: #6c757d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            color: var(--dark);
            padding: 20px 0;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 25px;
        }
        
        h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--dark);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #e9ecef;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        h2 {
            color: var(--dark);
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .checkbox-group input {
            width: auto;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--teal));
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), var(--orange));
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), var(--pink));
            color: white;
        }
        
        .btn-secondary {
            background: var(--neutral);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info), var(--blue));
            color: white;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-clean {
            background: linear-gradient(135deg, #6c757d, #868e96);
            color: white;
        }
        
        .btn-sync {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-primary {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
        }
        
        .badge-success {
            background: linear-gradient(135deg, var(--success), var(--teal));
            color: white;
        }
        
        .badge-warning {
            background: linear-gradient(135deg, var(--warning), var(--orange));
            color: white;
        }
        
        .badge-danger {
            background: linear-gradient(135deg, var(--danger), var(--pink));
            color: white;
        }
        
        .badge-info {
            background: linear-gradient(135deg, var(--info), var(--blue));
            color: white;
        }
        
        .badge-secondary {
            background: var(--neutral);
            color: white;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: var(--dark);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .urgent-high {
            border-left: 4px solid var(--danger);
        }
        
        .urgent-normal {
            border-left: 4px solid var(--warning);
        }
        
        .urgent-low {
            border-left: 4px solid var(--success);
        }
        
        .return-flag {
            background: #fff5f5 !important;
            position: relative;
        }
        
        .return-flag::after {
            content: 'üîÑ DEVOLU√á√ÉO';
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--danger);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 9px;
            font-weight: bold;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .login-header p {
            color: var(--dark);
            font-size: 14px;
            opacity: 0.8;
        }
        
        .hidden {
            display: none;
        }
        
        .os-code {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            background: #f8f9fa;
            padding: 10px 16px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        
        .print-only {
            display: none;
        }
        
        .sku-list {
            margin-top: 12px;
        }
        
        .sku-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .sku-item input {
            flex: 1;
        }
        
        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 5px;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pendente {
            background: linear-gradient(135deg, var(--warning), var(--orange));
            color: white;
        }
        
        .status-andamento {
            background: linear-gradient(135deg, var(--info), var(--blue));
            color: white;
        }
        
        .status-finalizado {
            background: linear-gradient(135deg, var(--success), var(--teal));
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            max-width: 450px;
            width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-title {
            color: var(--primary);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--danger);
        }
        
        .modal-form-group {
            margin-bottom: 15px;
        }
        
        .modal-form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .modal-form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .user-badge {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
        }
        
        .edited-by {
            font-size: 10px;
            color: var(--neutral);
            font-style: italic;
            margin-top: 2px;
        }
        
        .sync-status {
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .sync-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .sync-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .sync-loading {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block;
            }
            
            body {
                background: white;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Modal de Finaliza√ß√£o -->
    <div id="finalizarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-flag-checkered"></i> Finalizar Ordem de Servi√ßo</h3>
                <button class="close-modal" onclick="closeFinalizarModal()">&times;</button>
            </div>
            <form id="finalizarForm">
                <input type="hidden" id="finalizarOSId">
                <div class="modal-form-group">
                    <label for="fotosCount"><i class="fas fa-camera"></i> Quantidade de Fotos Tiradas</label>
                    <input type="number" id="fotosCount" min="0" value="0" required>
                </div>
                <div class="modal-form-group">
                    <label for="edicoesCount"><i class="fas fa-edit"></i> Quantidade de Edi√ß√µes Feitas</label>
                    <input type="number" id="edicoesCount" min="0" value="0" required>
                </div>
                <div class="btn-group" style="justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeFinalizarModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Finalizar OS
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1><i class="fas fa-camera"></i> Sistema OS Fotografia</h1>
            <p>Fa√ßa login para acessar o sistema</p>
        </div>
        <form id="loginForm">
            <div class="form-group">
                <label for="username">Usu√°rio</label>
                <input type="text" id="username" required placeholder="Digite seu usu√°rio">
            </div>
            <div class="form-group">
                <label for="password">Senha</label>
                <input type="password" id="password" required placeholder="Digite sua senha">
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
            </button>
        </form>
    </div>

    <!-- Sistema Principal -->
    <div id="mainSystem" class="hidden">
        <header>
            <div class="container">
                <div class="header-content">
                    <h1><i class="fas fa-camera"></i> Sistema de Ordem de Servi√ßo</h1>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">U</div>
                        <div>
                            <div id="userName" style="font-weight: bold;">Usu√°rio</div>
                            <button id="logoutBtn" class="btn btn-secondary" style="padding: 4px 8px; font-size: 10px; margin-top: 4px;">
                                <i class="fas fa-sign-out-alt"></i> Sair
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Configura√ß√£o do Google Sheets -->
            <div class="card no-print" id="configSection" style="display: none;">
                <div class="card-header">
                    <h2><i class="fas fa-cog"></i> Configura√ß√£o do Banco de Dados</h2>
                </div>
                <div class="form-group">
                    <label for="sheetUrl">URL do Google Sheets</label>
                    <input type="text" id="sheetUrl" placeholder="Cole a URL da sua planilha do Google Sheets">
                    <small style="color: #666; font-size: 12px;">
                        Instru√ß√µes: Crie uma planilha no Google Sheets, compartilhe como "Qualquer pessoa com o link pode editar" e cole a URL acima.
                    </small>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveSheetConfig()">
                        <i class="fas fa-save"></i> Salvar Configura√ß√£o
                    </button>
                    <button class="btn btn-info" onclick="testSheetConnection()">
                        <i class="fas fa-test"></i> Testar Conex√£o
                    </button>
                </div>
            </div>

            <!-- Formul√°rio de Nova OS -->
            <div class="card no-print">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Nova Ordem de Servi√ßo</h2>
                    <div>
                        <div class="os-code" id="osCodeDisplay">OS: Aguardando cria√ß√£o...</div>
                        <button class="btn btn-sync" onclick="syncWithCloud()" id="syncButton">
                            <i class="fas fa-cloud-upload-alt"></i> Sincronizar
                        </button>
                        <span id="syncStatus" class="sync-status" style="display: none;"></span>
                    </div>
                </div>
                
                <form id="osForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productName">Nome do Produto *</label>
                            <input type="text" id="productName" required placeholder="Digite o nome do produto">
                        </div>
                        <div class="form-group">
                            <label for="urgency">Grau de Urg√™ncia *</label>
                            <select id="urgency" required>
                                <option value="baixa">Baixa</option>
                                <option value="normal" selected>Normal</option>
                                <option value="alta">Alta</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="photoType">Tipo de Foto</label>
                            <select id="photoType">
                                <option value="studio">Est√∫dio</option>
                                <option value="bike">Na Bike</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="scalePhoto">Foto na Balan√ßa</label>
                            <select id="scalePhoto">
                                <option value="nao">N√£o</option>
                                <option value="sim">Sim</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>SKUs</label>
                            <div class="sku-list" id="skuList">
                                <div class="sku-item">
                                    <input type="text" class="sku-input" placeholder="C√≥digo SKU">
                                    <button type="button" class="btn btn-danger action-btn" onclick="removeSku(this)"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="addSku()" style="margin-top: 8px;">
                                <i class="fas fa-plus"></i> Adicionar SKU
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="links">Links (opcional)</label>
                            <input type="text" id="links" placeholder="Links relacionados ao produto">
                        </div>
                        <div class="form-group">
                            <label for="clip">Clip (opcional)</label>
                            <input type="text" id="clip" placeholder="N√∫mero do clip">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="checkbox-group">
                            <input type="checkbox" id="unpackProduct">
                            <label for="unpackProduct">Tirar produto da embalagem para foto</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="isReturn">
                            <label for="isReturn">√â uma devolu√ß√£o</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="observations">Observa√ß√µes</label>
                        <textarea id="observations" rows="3" placeholder="Observa√ß√µes adicionais..."></textarea>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Salvar OS
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="printCurrentOS()">
                            <i class="fas fa-print"></i> Imprimir OS
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-broom"></i> Limpar
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Lista de Ordens de Servi√ßo -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-list"></i> Ordens de Servi√ßo</h2>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="filterOS('pendente')">
                            <i class="fas fa-clock"></i> Pendentes
                        </button>
                        <button class="btn btn-info" onclick="filterOS('andamento')">
                            <i class="fas fa-play-circle"></i> Em Andamento
                        </button>
                        <button class="btn btn-success" onclick="filterOS('finalizado')">
                            <i class="fas fa-check-circle"></i> Finalizadas
                        </button>
                        <button class="btn btn-primary" onclick="filterOS('all')">
                            <i class="fas fa-layer-group"></i> Todas
                        </button>
                        <button class="btn btn-export" onclick="exportToExcel('all')">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                        <button class="btn btn-clean" onclick="limparConcluidas()">
                            <i class="fas fa-trash"></i> Limpar Conclu√≠das
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="osTable">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Produto</th>
                                <th>Criado por</th>
                                <th>Urg√™ncia</th>
                                <th>Status</th>
                                <th>Data Cria√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="osTableBody">
                            <!-- As OS ser√£o inseridas aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let currentUser = null;
        let osList = JSON.parse(localStorage.getItem('osList')) || [];
        let osCounter = parseInt(localStorage.getItem('osCounter')) || 1;
        let currentFilter = 'pendente';
        let currentEditingOS = null;
        let sheetUrl = localStorage.getItem('sheetUrl') || '';

        // Elementos DOM
        const loginScreen = document.getElementById('loginScreen');
        const mainSystem = document.getElementById('mainSystem');
        const configSection = document.getElementById('configSection');
        const loginForm = document.getElementById('loginForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const osForm = document.getElementById('osForm');
        const osCodeDisplay = document.getElementById('osCodeDisplay');
        const isReturnCheckbox = document.getElementById('isReturn');
        const urgencySelect = document.getElementById('urgency');
        const osTableBody = document.getElementById('osTableBody');
        const finalizarModal = document.getElementById('finalizarModal');
        const finalizarForm = document.getElementById('finalizarForm');
        const finalizarOSId = document.getElementById('finalizarOSId');
        const sheetUrlInput = document.getElementById('sheetUrl');
        const syncButton = document.getElementById('syncButton');
        const syncStatus = document.getElementById('syncStatus');

        // Configurar URL da planilha se existir
        if (sheetUrl) {
            sheetUrlInput.value = sheetUrl;
        }

        // Usu√°rios do sistema
        const users = [
            { username: 'elaine', password: 'elaine123', name: 'Elaine', avatar: 'E' },
            { username: 'arthur', password: 'arthur123', name: 'Arthur', avatar: 'A' },
            { username: 'laura', password: 'laura123', name: 'Laura', avatar: 'L' },
            { username: 'ronald', password: 'ronald123', name: 'Ronald', avatar: 'R' },
            { username: 'bruna', password: 'bruna123', name: 'Bruna', avatar: 'B' }
        ];

        // Event Listeners
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        osForm.addEventListener('submit', handleOSSubmit);
        isReturnCheckbox.addEventListener('change', handleReturnChange);
        finalizarForm.addEventListener('submit', handleFinalizarOS);

        // Fun√ß√µes de Login
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                userName.textContent = user.name;
                userAvatar.textContent = user.avatar;
                loginScreen.classList.add('hidden');
                mainSystem.classList.remove('hidden');
                
                // Mostrar configura√ß√£o se n√£o tiver URL da planilha
                if (!sheetUrl) {
                    configSection.style.display = 'block';
                }
                
                generateOSCode();
                renderOSTable();
                
                // Tentar sincronizar com a nuvem ao fazer login
                if (sheetUrl) {
                    setTimeout(() => {
                        loadFromCloud();
                    }, 1000);
                }
            } else {
                alert('‚ùå Usu√°rio ou senha incorretos!');
            }
        }

        function handleLogout() {
            currentUser = null;
            mainSystem.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Fun√ß√µes do Google Sheets
        function saveSheetConfig() {
            const url = sheetUrlInput.value.trim();
            if (!url) {
                alert('‚ùå Por favor, insira a URL da planilha do Google Sheets.');
                return;
            }
            
            sheetUrl = url;
            localStorage.setItem('sheetUrl', url);
            configSection.style.display = 'none';
            alert('‚úÖ Configura√ß√£o salva! Agora voc√™ pode sincronizar com a nuvem.');
        }

        function testSheetConnection() {
            const url = sheetUrlInput.value.trim();
            if (!url) {
                alert('‚ùå Por favor, insira a URL da planilha primeiro.');
                return;
            }
            
            updateSyncStatus('Testando conex√£o...', 'loading');
            
            // Simular teste de conex√£o (em produ√ß√£o, isso faria uma requisi√ß√£o real)
            setTimeout(() => {
                updateSyncStatus('Conex√£o bem-sucedida!', 'success');
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 3000);
            }, 2000);
        }

        async function syncWithCloud() {
            if (!sheetUrl) {
                alert('‚ùå Configure a URL do Google Sheets primeiro.');
                configSection.style.display = 'block';
                return;
            }

            updateSyncStatus('Sincronizando...', 'loading');
            
            try {
                // Salvar dados locais na nuvem
                await saveToCloud();
                
                // Carregar dados da nuvem (para pegar atualiza√ß√µes de outros usu√°rios)
                await loadFromCloud();
                
                updateSyncStatus('Sincronizado com sucesso!', 'success');
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                updateSyncStatus('Erro na sincroniza√ß√£o', 'error');
                console.error('Erro na sincroniza√ß√£o:', error);
            }
        }

        async function saveToCloud() {
            // Em um ambiente real, aqui voc√™ faria uma requisi√ß√£o para uma API
            // que salvaria os dados no Google Sheets usando Google Apps Script
            
            // Simulando o salvamento na nuvem
            return new Promise((resolve) => {
                setTimeout(() => {
                    localStorage.setItem('cloudData', JSON.stringify({
                        osList: osList,
                        osCounter: osCounter,
                        lastSync: new Date().toISOString()
                    }));
                    resolve();
                }, 1000);
            });
        }

        async function loadFromCloud() {
            // Em um ambiente real, aqui voc√™ faria uma requisi√ß√£o para uma API
            // que buscaria os dados do Google Sheets
            
            return new Promise((resolve) => {
                setTimeout(() => {
                    const cloudData = localStorage.getItem('cloudData');
                    if (cloudData) {
                        const data = JSON.parse(cloudData);
                        
                        // Mesclar dados locais com dados da nuvem
                        osList = mergeOSLists(osList, data.osList);
                        osCounter = Math.max(osCounter, data.osCounter);
                        
                        saveData();
                        renderOSTable();
                    }
                    resolve();
                }, 1000);
            });
        }

        function mergeOSLists(localList, cloudList) {
            const merged = [...localList];
            
            cloudList.forEach(cloudOS => {
                const localIndex = merged.findIndex(localOS => localOS.id === cloudOS.id);
                
                if (localIndex === -1) {
                    // OS nova da nuvem
                    merged.push(cloudOS);
                } else {
                    // Mesclar OS existente (manter a mais recente)
                    const localOS = merged[localIndex];
                    const cloudDate = new Date(cloudOS.lastUpdate || cloudOS.creationDate);
                    const localDate = new Date(localOS.lastUpdate || localOS.creationDate);
                    
                    if (cloudDate > localDate) {
                        merged[localIndex] = cloudOS;
                    }
                }
            });
            
            return merged;
        }

        function updateSyncStatus(message, type) {
            syncStatus.textContent = message;
            syncStatus.className = `sync-status sync-${type}`;
            syncStatus.style.display = 'inline-block';
            
            if (type === 'loading') {
                syncStatus.innerHTML = `<div class="loading" style="display: inline-block; margin-right: 5px;"></div> ${message}`;
            }
        }

        // Fun√ß√µes de OS (mantidas as mesmas, com pequenas adapta√ß√µes)
        function generateOSCode() {
            const timestamp = new Date().getTime().toString().slice(-4);
            const code = `OS${osCounter.toString().padStart(4, '0')}-${timestamp}`;
            osCodeDisplay.textContent = `OS: ${code}`;
            return code;
        }

        function handleOSSubmit(e) {
            e.preventDefault();
            
            const skus = Array.from(document.querySelectorAll('.sku-input'))
                .map(input => input.value.trim())
                .filter(sku => sku !== '');
            
            const os = {
                id: currentEditingOS ? currentEditingOS.id : osCounter++,
                code: currentEditingOS ? currentEditingOS.code : generateOSCode(),
                productName: document.getElementById('productName').value,
                createdBy: currentEditingOS ? currentEditingOS.createdBy : currentUser.name,
                lastEditedBy: currentUser.name,
                urgency: document.getElementById('urgency').value,
                creationDate: currentEditingOS ? currentEditingOS.creationDate : new Date().toLocaleDateString('pt-BR'),
                conclusionDate: currentEditingOS ? currentEditingOS.conclusionDate : null,
                elaineCompletion: currentEditingOS ? currentEditingOS.elaineCompletion : null,
                salesCompletion: currentEditingOS ? currentEditingOS.salesCompletion : null,
                photoType: document.getElementById('photoType').value,
                scalePhoto: document.getElementById('scalePhoto').value,
                unpackProduct: document.getElementById('unpackProduct').checked,
                isReturn: document.getElementById('isReturn').checked,
                links: document.getElementById('links').value,
                clip: document.getElementById('clip').value,
                observations: document.getElementById('observations').value,
                skus: skus,
                status: currentEditingOS ? currentEditingOS.status : 'pendente',
                photosCount: currentEditingOS ? currentEditingOS.photosCount : 0,
                editsCount: currentEditingOS ? currentEditingOS.editsCount : 0,
                lastUpdate: new Date().toISOString()
            };
            
            if (currentEditingOS) {
                const index = osList.findIndex(item => item.id === currentEditingOS.id);
                if (index !== -1) {
                    osList[index] = os;
                }
                currentEditingOS = null;
            } else {
                osList.push(os);
            }
            
            saveData();
            renderOSTable();
            osForm.reset();
            generateOSCode();
            alert('‚úÖ Ordem de Servi√ßo salva com sucesso!');
            
            // Sincronizar automaticamente com a nuvem
            if (sheetUrl) {
                setTimeout(() => {
                    saveToCloud();
                }, 500);
            }
        }

        // ... (restante das fun√ß√µes permanecem as mesmas do c√≥digo anterior)
        // handleReturnChange, addSku, removeSku, renderOSTable, filterOS, viewOS, editOS,
        // updateStatus, openFinalizarModal, closeFinalizarModal, handleFinalizarOS,
        // exportToExcel, limparConcluidas, printOS, printCurrentOS, deleteOS

        function saveData() {
            localStorage.setItem('osList', JSON.stringify(osList));
            localStorage.setItem('osCounter', osCounter.toString());
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            generateOSCode();
            
            // Tentar carregar dados da nuvem ao iniciar
            if (sheetUrl) {
                setTimeout(() => {
                    loadFromCloud();
                }, 1000);
            }
        });

        // ... (implementar as fun√ß√µes restantes aqui - elas s√£o as mesmas do c√≥digo anterior)
        // Para economizar espa√ßo, mantive apenas as fun√ß√µes principais modificadas

    </script>

    <script>
        // Implementa√ß√£o das fun√ß√µes restantes (iguais ao c√≥digo anterior)
        function handleReturnChange() {
            if (isReturnCheckbox.checked) {
                urgencySelect.value = 'alta';
            }
        }

        function addSku() {
            const skuList = document.getElementById('skuList');
            const skuItem = document.createElement('div');
            skuItem.className = 'sku-item';
            skuItem.innerHTML = `
                <input type="text" class="sku-input" placeholder="C√≥digo SKU">
                <button type="button" class="btn btn-danger action-btn" onclick="removeSku(this)"><i class="fas fa-times"></i></button>
            `;
            skuList.appendChild(skuItem);
        }

        function removeSku(button) {
            if (document.querySelectorAll('.sku-item').length > 1) {
                button.parentElement.remove();
            }
        }

        function renderOSTable() {
            osTableBody.innerHTML = '';
            
            const filteredOS = currentFilter === 'all' 
                ? osList 
                : osList.filter(os => os.status === currentFilter);
            
            filteredOS.forEach(os => {
                const row = document.createElement('tr');
                row.className = `urgent-${os.urgency} ${os.isReturn ? 'return-flag' : ''}`;
                
                let statusBadge = '';
                if (os.status === 'pendente') {
                    statusBadge = '<span class="status-badge status-pendente">Pendente</span>';
                } else if (os.status === 'andamento') {
                    statusBadge = '<span class="status-badge status-andamento">Em Andamento</span>';
                } else if (os.status === 'finalizado') {
                    statusBadge = '<span class="status-badge status-finalizado">Finalizado</span>';
                }
                
                let urgencyBadge = '';
                if (os.urgency === 'baixa') {
                    urgencyBadge = '<span class="badge badge-success">Baixa</span>';
                } else if (os.urgency === 'normal') {
                    urgencyBadge = '<span class="badge badge-warning">Normal</span>';
                } else if (os.urgency === 'alta') {
                    urgencyBadge = '<span class="badge badge-danger">Alta</span>';
                }
                
                let actionButtons = '';
                if (os.status === 'pendente') {
                    actionButtons = `
                        <button class="btn btn-success action-btn" onclick="updateStatus(${os.id}, 'andamento')" title="Iniciar OS">
                            <i class="fas fa-play"></i>
                        </button>
                    `;
                } else if (os.status === 'andamento') {
                    actionButtons = `
                        <button class="btn btn-info action-btn" onclick="openFinalizarModal(${os.id})" title="Finalizar OS">
                            <i class="fas fa-flag-checkered"></i>
                        </button>
                    `;
                }
                
                const editedInfo = os.lastEditedBy !== os.createdBy ? 
                    `<div class="edited-by">Editado por: ${os.lastEditedBy}</div>` : '';
                
                row.innerHTML = `
                    <td><strong>${os.code}</strong></td>
                    <td>${os.productName}</td>
                    <td>
                        <span class="badge user-badge">${os.createdBy}</span>
                        ${editedInfo}
                    </td>
                    <td>${urgencyBadge}</td>
                    <td>${statusBadge}</td>
                    <td>${os.creationDate}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary action-btn" onclick="viewOS(${os.id})" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning action-btn" onclick="editOS(${os.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${actionButtons}
                            <button class="btn btn-secondary action-btn" onclick="printOS(${os.id})" title="Imprimir">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="btn btn-danger action-btn" onclick="deleteOS(${os.id})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                osTableBody.appendChild(row);
            });
        }

        function filterOS(status) {
            currentFilter = status;
            renderOSTable();
        }

        function viewOS(id) {
            const os = osList.find(os => os.id === id);
            if (os) {
                const skusText = os.skus.length > 0 ? os.skus.join(', ') : 'Nenhum SKU informado';
                const finalizacaoElaine = os.elaineCompletion ? `Elaine: ${os.elaineCompletion}` : 'N√£o finalizada por Elaine';
                const finalizacaoVendas = os.salesCompletion ? `Vendas: ${os.salesCompletion}` : 'N√£o finalizada por Vendas';
                const fotosEdicoes = os.photosCount || os.editsCount ? `Fotos: ${os.photosCount}, Edi√ß√µes: ${os.editsCount}` : 'N√£o informado';
                const editedInfo = os.lastEditedBy !== os.createdBy ? `\n‚úèÔ∏è √öltima edi√ß√£o por: ${os.lastEditedBy}` : '';
                
                alert(`üìã Detalhes da OS:\n\nüè∑Ô∏è C√≥digo: ${os.code}\nüì¶ Produto: ${os.productName}\nüìä Status: ${os.status}\n‚ö†Ô∏è Urg√™ncia: ${os.urgency}\nüìÖ Data Cria√ß√£o: ${os.creationDate}\nüë§ Criado por: ${os.createdBy}${editedInfo}\nüì∏ Tipo Foto: ${os.photoType}\n‚öñÔ∏è Foto Balan√ßa: ${os.scalePhoto}\nüì¶ Desembalar: ${os.unpackProduct ? 'Sim' : 'N√£o'}\nüîÑ Devolu√ß√£o: ${os.isReturn ? 'Sim' : 'N√£o'}\nüè∑Ô∏è SKUs: ${skusText}\nüìù Observa√ß√µes: ${os.observations || 'Nenhuma'}\nüìä ${fotosEdicoes}\n‚úÖ ${finalizacaoElaine}\nüí∞ ${finalizacaoVendas}`);
            }
        }

        function editOS(id) {
            const os = osList.find(os => os.id === id);
            if (os) {
                currentEditingOS = os;
                
                document.getElementById('productName').value = os.productName;
                document.getElementById('urgency').value = os.urgency;
                document.getElementById('photoType').value = os.photoType;
                document.getElementById('scalePhoto').value = os.scalePhoto;
                document.getElementById('unpackProduct').checked = os.unpackProduct;
                document.getElementById('isReturn').checked = os.isReturn;
                document.getElementById('links').value = os.links;
                document.getElementById('clip').value = os.clip;
                document.getElementById('observations').value = os.observations;
                
                const skuList = document.getElementById('skuList');
                skuList.innerHTML = '';
                os.skus.forEach(sku => {
                    const skuItem = document.createElement('div');
                    skuItem.className = 'sku-item';
                    skuItem.innerHTML = `
                        <input type="text" class="sku-input" value="${sku}">
                        <button type="button" class="btn btn-danger action-btn" onclick="removeSku(this)"><i class="fas fa-times"></i></button>
                    `;
                    skuList.appendChild(skuItem);
                });
                
                if (os.skus.length === 0) {
                    addSku();
                }
                
                osCodeDisplay.textContent = `OS: ${os.code}`;
                
                alert('üìù OS carregada para edi√ß√£o!');
            }
        }

        function updateStatus(id, status) {
            const os = osList.find(os => os.id === id);
            if (os) {
                if (status === 'andamento' && os.status === 'pendente') {
                    os.status = 'andamento';
                    os.lastEditedBy = currentUser.name;
                    os.lastUpdate = new Date().toISOString();
                    alert('üöÄ OS iniciada com sucesso!');
                    saveData();
                    renderOSTable();
                    
                    if (sheetUrl) {
                        saveToCloud();
                    }
                }
            }
        }

        function openFinalizarModal(id) {
            const os = osList.find(os => os.id === id);
            if (os && os.status === 'andamento') {
                finalizarOSId.value = id;
                document.getElementById('fotosCount').value = os.photosCount || 0;
                document.getElementById('edicoesCount').value = os.editsCount || 0;
                finalizarModal.style.display = 'flex';
            }
        }

        function closeFinalizarModal() {
            finalizarModal.style.display = 'none';
        }

        function handleFinalizarOS(e) {
            e.preventDefault();
            
            const osId = parseInt(finalizarOSId.value);
            const fotosCount = parseInt(document.getElementById('fotosCount').value);
            const edicoesCount = parseInt(document.getElementById('edicoesCount').value);
            
            const os = osList.find(os => os.id === osId);
            if (os) {
                os.status = 'finalizado';
                os.photosCount = fotosCount;
                os.editsCount = edicoesCount;
                os.conclusionDate = new Date().toLocaleDateString('pt-BR');
                os.lastEditedBy = currentUser.name;
                os.lastUpdate = new Date().toISOString();
                
                if (currentUser.name === 'Elaine') {
                    os.elaineCompletion = new Date().toLocaleDateString('pt-BR');
                } else {
                    os.salesCompletion = new Date().toLocaleDateString('pt-BR');
                }
                
                saveData();
                renderOSTable();
                closeFinalizarModal();
                alert('‚úÖ OS finalizada com sucesso!\n\nüì∏ Fotos: ' + fotosCount + '\nüé® Edi√ß√µes: ' + edicoesCount);
                
                if (sheetUrl) {
                    saveToCloud();
                }
            }
        }

        function exportToExcel(filter) {
            let dataToExport;
            
            if (filter === 'all') {
                dataToExport = osList;
            } else {
                dataToExport = osList.filter(os => os.status === 'finalizado');
            }
            
            if (dataToExport.length === 0) {
                alert('‚ùå Nenhuma OS encontrada para exportar!');
                return;
            }
            
            const excelData = dataToExport.map(os => ({
                'C√≥digo OS': os.code,
                'Produto': os.productName,
                'Criado por': os.createdBy,
                '√öltima edi√ß√£o por': os.lastEditedBy,
                'Urg√™ncia': os.urgency,
                'Status': os.status,
                'Data Cria√ß√£o': os.creationDate,
                'Data Conclus√£o': os.conclusionDate || 'N√£o conclu√≠da',
                'Tipo Foto': os.photoType === 'studio' ? 'Est√∫dio' : 'Na Bike',
                'Foto Balan√ßa': os.scalePhoto === 'sim' ? 'Sim' : 'N√£o',
                'Desembalar': os.unpackProduct ? 'Sim' : 'N√£o',
                'Devolu√ß√£o': os.isReturn ? 'Sim' : 'N√£o',
                'Fotos Tiradas': os.photosCount,
                'Edi√ß√µes Feitas': os.editsCount,
                'SKUs': os.skus.join(', '),
                'Links': os.links || '',
                'Clip': os.clip || '',
                'Observa√ß√µes': os.observations || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ordens de Servi√ßo');
            
            const fileName = filter === 'all' ? 'todas_os.xlsx' : 'os_concluidas.xlsx';
            XLSX.writeFile(wb, fileName);
            alert(`‚úÖ ${dataToExport.length} OS exportadas com sucesso!`);
        }

        function limparConcluidas() {
            const concluidas = osList.filter(os => os.status === 'finalizado');
            
            if (concluidas.length === 0) {
                alert('‚ùå Nenhuma OS conclu√≠da encontrada para limpar!');
                return;
            }
            
            if (confirm(`‚ö†Ô∏è Tem certeza que deseja excluir ${concluidas.length} OS conclu√≠das? Esta a√ß√£o n√£o pode ser desfeita!`)) {
                osList = osList.filter(os => os.status !== 'finalizado');
                saveData();
                renderOSTable();
                alert(`‚úÖ ${concluidas.length} OS conclu√≠das foram exclu√≠das!`);
                
                if (sheetUrl) {
                    saveToCloud();
                }
            }
        }

        function printOS(id) {
            const os = osList.find(os => os.id === id);
            if (os) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>OS: ${os.code}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                            .os-code { font-size: 24px; font-weight: bold; color: #8A2BE2; margin: 10px 0; }
                            .section { margin-bottom: 20px; }
                            .section h3 { background: #f0f0f0; padding: 8px; margin: 15px 0 10px 0; }
                            .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
                            .info-item { margin-bottom: 8px; }
                            .label { font-weight: bold; }
                            .urgent-alta { color: #FF4757; font-weight: bold; }
                            .urgent-normal { color: #FFA500; }
                            .urgent-baixa { color: #00D26A; }
                            .return-flag { background: #ffeaea; padding: 5px; border-radius: 3px; font-weight: bold; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Ordem de Servi√ßo - Fotografia</h1>
                            <div class="os-code">${os.code}</div>
                            <div>Emitida em: ${os.creationDate}</div>
                        </div>
                        
                        <div class="section">
                            <h3>Informa√ß√µes do Produto</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="label">Produto:</span> ${os.productName}
                                </div>
                                <div class="info-item">
                                    <span class="label">Criado por:</span> ${os.createdBy}
                                </div>
                                ${os.lastEditedBy !== os.createdBy ? `
                                <div class="info-item">
                                    <span class="label">√öltima edi√ß√£o por:</span> ${os.lastEditedBy}
                                </div>
                                ` : ''}
                                <div class="info-item">
                                    <span class="label">Urg√™ncia:</span> 
                                    <span class="urgent-${os.urgency}">${os.urgency.toUpperCase()}</span>
                                </div>
                                <div class="info-item">
                                    <span class="label">Status:</span> ${os.status.toUpperCase()}
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <h3>Detalhes da Fotografia</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="label">Tipo de Foto:</span> ${os.photoType === 'studio' ? 'Est√∫dio' : 'Na Bike'}
                                </div>
                                <div class="info-item">
                                    <span class="label">Foto na Balan√ßa:</span> ${os.scalePhoto === 'sim' ? 'Sim' : 'N√£o'}
                                </div>
                                <div class="info-item">
                                    <span class="label">Desembalar Produto:</span> ${os.unpackProduct ? 'Sim' : 'N√£o'}
                                </div>
                                ${os.isReturn ? '<div class="info-item"><span class="return-flag">üîÑ √â UMA DEVOLU√á√ÉO</span></div>' : ''}
                            </div>
                        </div>
                        
                        ${os.skus.length > 0 ? `
                        <div class="section">
                            <h3>SKUs</h3>
                            <div>${os.skus.join(', ')}</div>
                        </div>
                        ` : ''}
                        
                        ${os.links ? `
                        <div class="section">
                            <h3>Links</h3>
                            <div>${os.links}</div>
                        </div>
                        ` : ''}
                        
                        ${os.observations ? `
                        <div class="section">
                            <h3>Observa√ß√µes</h3>
                            <div>${os.observations}</div>
                        </div>
                        ` : ''}
                        
                        ${os.status === 'finalizado' ? `
                        <div class="section">
                            <h3>Finaliza√ß√£o</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="label">Data Conclus√£o:</span> ${os.conclusionDate}
                                </div>
                                <div class="info-item">
                                    <span class="label">Fotos Tiradas:</span> ${os.photosCount}
                                </div>
                                <div class="info-item">
                                    <span class="label">Edi√ß√µes Feitas:</span> ${os.editsCount}
                                </div>
                                ${os.elaineCompletion ? `<div class="info-item"><span class="label">Finalizado por Elaine:</span> ${os.elaineCompletion}</div>` : ''}
                                ${os.salesCompletion ? `<div class="info-item"><span class="label">Finalizado por Vendas:</span> ${os.salesCompletion}</div>` : ''}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: center; font-size: 12px; color: #666;">
                            Sistema de Ordem de Servi√ßo - Fotografia | ${new Date().toLocaleDateString('pt-BR')}
                        </div>
                        
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 500);
                            }
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
            }
        }

        function printCurrentOS() {
            alert('üìù Para imprimir uma OS espec√≠fica, use o bot√£o de impress√£o na lista de OS j√° criadas.');
        }

        function deleteOS(id) {
            if (confirm('‚ùì Tem certeza que deseja excluir esta Ordem de Servi√ßo?')) {
                osList = osList.filter(os => os.id !== id);
                saveData();
                renderOSTable();
                alert('üóëÔ∏è OS exclu√≠da com sucesso!');
                
                if (sheetUrl) {
                    saveToCloud();
                }
            }
        }
    </script>
</body>
</html>